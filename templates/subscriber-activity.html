<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Chart.js Example</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.7.2/dist/vuetify.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        .flex {
            display: flex;
        }

        .flex-between {
            justify-content: space-between;
        }

        .text-center {
            text-align: center;
        }

        .card {
            border: 1px solid #000;
            border-radius: 5px;
            padding: 10px;
            margin: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .width-50p {
            width: 50%;
        }
    </style>

</head>

<body>
    <div class="container">
        <h1 style="text-align: center" >احصائيات الانضمام والمغادرة</h1>
        <div id="app">
            <v-locale-provider rtl>
                <v-container>
                    <div class="flex flex-between" style="margin-top: 40px">
                        <div class="flex flex-between">
                            <div class="card text-center">
                                <h3>اجمالي الاعضاء الحالي</h3>
                                <h2>[[ total_members ]]</h2>
                            </div>

                            <div class="card text-center">
                                <h3>أعلى معدل انضمام في يوم واحد</h3>
                                <h2>[[ most_joins_in_a_day ]]</h2>
                            </div>
                        </div>

                        <div class="flex flex-between">
                            <div class="card text-center">
                                <h3>المشتركين خلال شهر</h3>
                                <h2>[[ joined_within_a_month_percentage ]]%</h2>
                            </div>

                            <div class="card text-center">
                                <h3>المغادرين خلال شهر</h3>
                                <h2>[[ leaving_within_a_month_percentage ]]%</h2>
                            </div>

                            <div class="card text-center">
                                <h3>نسبة النمو الشهرية</h3>
                                <h2>[[ monthly_growth_percentage ]]%</h2>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-between">

                        <div class="width-50p">
                            <v-data-table :headers="tableHeaders" :items="tableData">
                            </v-data-table>
                        </div>

                        <div class="width-50p">
                            <div style="margin-top: 40px;">
                                {# <v-btn @click="fetchData('day')">يوم</v-btn>#}
                                <v-btn @click="fetchData('week')" style="margin-left: 10px">اسبوع</v-btn>
                                <v-btn @click="fetchData('month')" style="margin-left: 10px">شهر</v-btn>
                            </div>
                            <canvas id="myChart" width="400" height="400"></canvas>
                        </div>
                    </div>
                </v-container>

            </v-locale-provider>

        </div>
    </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@3.7.2/dist/vuetify.min.js"></script>
        <script src="https://unpkg.com/vue-chartjs@3.4.0/dist/vue-chartjs.js"></script>
        <script>
            const { createApp, ref, onMounted } = Vue
            const { createVuetify } = Vuetify
            const vuetify = createVuetify()

            var app = createApp({
                delimiters: ['[[', ']]'],
                setup() {
                    const total_members = ref(0)
                    const joined_within_a_month_percentage = ref('0')
                    const leaving_within_a_month_percentage = ref('0')
                    const monthly_growth_percentage = ref('0')
                    const most_joins_in_a_day = ref('0')

                    const tableHeaders = [
                        { title: 'معرف التليجرام', value: 'telegram_id' },
                        { title: 'اسم المستخدم', value: 'telegram_username' },
                        { title: 'رقم الجوال', value: 'phone_number' },
                        { title: 'عدد الايام المتبقية قبل المغادرة', value: 'days_left' },
                        { title: 'التاريخ المتوقع للمغادرة', value: 'end_date' }
                    ]
                    const tableData = ref([])

                    onMounted(() => {
                        initChart();

                        // Fetch initial data
                        fetchData('month');
                    })

                    var myChart;

                    const initChart = () => {
                        const ctx = document.getElementById('myChart').getContext('2d');
                        myChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: [],
                                datasets: [
                                    {
                                        label: 'المغادرين',
                                        data: [],
                                        backgroundColor: [
                                            'rgba(255, 99, 132, 0.2)'
                                        ],
                                        borderColor: [
                                            'rgba(255, 99, 132, 1)'
                                        ],
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'المنضمين',
                                        data: [],
                                        backgroundColor: [
                                            'rgba(33, 174, 33, 0.2)'
                                        ],
                                        borderColor: [
                                            'rgba(33, 174, 33, 1)'
                                        ],
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    }

                    const fetchData = (filter) => {
                        $.ajax({
                            url: `/api/subscriber-activity/?filter=${filter}`,
                            method: 'GET',
                            success: function (data) {
                                const chartData = data.chart_data
                                total_members.value = data.total_members
                                joined_within_a_month_percentage.value = data.joined_within_a_month_percentage
                                leaving_within_a_month_percentage.value = data.leaving_within_a_month_percentage
                                monthly_growth_percentage.value = data.monthly_growth_percentage
                                most_joins_in_a_day.value = data.most_joins_in_a_day
                                tableData.value = data.table_data
                                const joiningData = chartData.joined;
                                const leavingData = chartData.left;

                                myChart.data.labels = chartData.labels;
                                myChart.data.datasets[0].data = joiningData;
                                myChart.data.datasets[1].data = leavingData;
                                myChart.update();
                            }
                        });
                    }
                    return {
                        total_members,
                        joined_within_a_month_percentage,
                        leaving_within_a_month_percentage,
                        monthly_growth_percentage,
                        most_joins_in_a_day,
                        tableHeaders,
                        tableData,
                        fetchData
                    }
                }
            })
            app.use(vuetify);
            app.mount('#app')

        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
</body>

</html>